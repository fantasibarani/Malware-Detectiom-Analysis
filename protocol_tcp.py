import dpkt
import os
import pcapy as p
from scapy.all import *
from collections import Counter
# print '-----------------------------'
hit1_tcp=0
hit2_tcp=0
hit3_tcp=0
kalk_tcp=0
rod_tcp_1=0
rod_tcp_2=0
rod_tcp_3=0
size_a_tcp=0
size_b_tcp=0
size_c_tcp=0
http=0
protokol_dns1=[]
protokol_dns2=[]
protokol_dns3=[]
a_pro=0
b_pro=0
c_pro=0
filename='dump.pcap'
# untuk setiap ts, pkt pada dump.pcap file
# print 'Akses Port TCP yang dilakukan'
# print '-----------------------------'
for ts, pkt in dpkt.pcap.Reader(open(filename,'r')):
  eth=dpkt.ethernet.Ethernet(pkt) 
  if eth.type !=dpkt.ethernet.ETH_TYPE_IP:
    continue
  ip=eth.data
  if ip.p==dpkt.ip.IP_PROTO_TCP: 
    tcp = ip.data
  try :
    if int(format(tcp.dport)) in range (0,1023) :
      rod_tcp_1+=1
      hit1_tcp=1
      protokol_dns1.append(int(format(tcp.dport)))
      # print "Well  Known Port TCP"
    elif int(format(tcp.dport)) in range (1024,49152) :
      rod_tcp_2+=1
      hit2_tcp=1
      protokol_dns2.append(int(format(tcp.dport)))
      # print "Registered Port TCP"
    elif int(format(tcp.dport))in range (49152,65537):
      rod_tcp_3+=1
      hit3_tcp=1
      protokol_dns3.append(int(format(tcp.dport)))
      # print "Dynamic Assigned Port TCP"
  except:
    print "---."


print "---------------------------------" 
# print "DNS 1     : ", hit1_tcp
prodns1=Counter(protokol_dns1)
# print prodns1
for indeks in range(len(prodns1)):
  a_pro=a_pro+1 
# print "Jumlah Node DNS 1 : ", a_pro
print "---------------------------------"
# print "DNS 2     : ", hit2_tcp
prodns2=Counter(protokol_dns2)
# print prodns2
for indeks in range(len(prodns2)):
  b_pro=b_pro+1 
# print "Jumlah Node DNS 2 : ", b_pro
print "---------------------------------"
# print "DNS 3     : ", hit3_tcp
prodns3=Counter(protokol_dns3)
# print prodns3
for indeks in range(len(prodns3)):
  c_pro=c_pro+1 


if hit1_tcp!=0:
  size_a_tcp=1
if hit2_tcp!=0:
  size_b_tcp=1
if hit3_tcp!=0:
  size_c_tcp=1
# dns_node_tcp=size_a_tcp+size_b_tcp+size_c_tcp
# # print dns_node_tcp

# print "---------------------------------"
root_out_tcp=rod_tcp_1+rod_tcp_2+rod_tcp_3
# print root_out_tcp